import boto3
import json
import botocore
import os
from json_datetime_serializer import json_datetime_serializer
import logging
from moto import mock_ec2
from describe_ec2_instances import describe_instances

logger = logging.getLogger()
logging.basicConfig(level=logging.INFO,
                    format='%(asctime)s: %(levelname)s: %(message)s')


# Creating snapshot from EC2 instance.

# @mock_ec2
def create_snapshot(instance_id):
    client = boto3.client('ec2')
    volume_id = describe_instances(instance_id)
    response = client.create_snapshot(
        VolumeId=volume_id
    )
    snapshot_id = response['SnapshotId']
    snapshot_complete_waiter = client.get_waiter('snapshot_completed')
    try:
        snapshot_complete_waiter.wait(SnapshotIds=[snapshot_id])
        logger.info(f'Snapshot successfully created..with  snapshot-id: {snapshot_id}')
    except botocore.exceptions.WaiterError as e:
        if "Max attempts exceeded" in e.message:
            logger.info('Snapshot did not complete in 600 seconds..')
        else:
            logger.info(f'Message---{e.message}')
    return snapshot_id
                

# if __name__ == '__main__':
#     logger.info('Snapshot creating function......!')
#     instance_id = input('Enter an instance id: ')   
#     ec2 = create_snapshot(instance_id)
#     logger.info('Creating a snapshot ...')
#     logger.info(
#         f'Snapshot details: {json.dumps(ec2, indent=4, default=json_datetime_serializer)}'
#     )
#     logger.info('Done!')