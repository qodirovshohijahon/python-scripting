import boto3
import json
import logging
from moto import mock_ec2
import os
import botocore
from json_datetime_serializer import json_datetime_serializer
from describe_ec2_instances import describe_instances

logger = logging.getLogger()
logging.basicConfig(level=logging.INFO,
                    format='%(asctime)s: %(levelname)s: %(message)s')


# Stopping the instance using stop_instances.
# @mock_ec2
def detach_volume(instance_id):
    client = boto3.client('ec2')
    volume_id = describe_instances(instance_id)
    response = client.detach_volume(
        InstanceId=instance_id,
        VolumeId=volume_id,
    )
    detached_volume_id = response['VolumeId'] 
    detaching_volume_waiter = client.get_waiter('volume_available')
    try:
        detaching_volume_waiter.wait(VolumeIds=[detached_volume_id])
        logger.info(f'Volume successfully detached volume-id: {detached_volume_id}')

    except botocore.exceptions.WaiterError as e:
        if "Max attempts exceeded" in e.message:
            logger.info('Detaching did not complete in 600 seconds..')
        else:
            logger.info(f'Message---{e.message}')

    return detached_volume_id

    
if __name__ == '__main__':
    logger.info('Detaching volume function......!')
    instance_id = input('Enter an instance id: ')   
    volume = detach_volume(instance_id)
    logger.info('Detaching EC2 instance...')
    logger.info(
        f'Detaching instance with details: {json.dumps(volume, indent=4, default=json_datetime_serializer)}'
    )
    logger.info('Volume Successfully Detached!!!')
    
        
        


