#!/usr/bin/env python
import boto3
import botocore
import pprint

print("EC2 Instances")
print("=============")
ssm=boto3.session.Session().client("ssm")
reg=ssm.get_parameters_by_path(Path="/aws/service/global-infrastructure/regions")
results=reg['Parameters']
while 'NextToken' in reg:
    reg=ssm.get_parameters_by_path(Path="/aws/service/global-infrastructure/regions",NextToken=reg['NextToken'])
    results.extend(reg['Parameters'])
for x1 in results:
    try:
        ec2=session=boto3.session.Session(profile_name="scenario3",region_name=x1['Value']).client("ec2")
        ecs=ec2.describe_instances()
        for x2 in ecs['Reservations']:
            for x3 in x2['Instances']:
                name=x3['InstanceId']
                for x4 in x3['Tags']:
                    if x4['Key']=='Name':
                        name=x4['Value']
                pubip=""
                if 'PublicIPAddress' in x3:
                    pubip=x3['PublicIPAddress']
                print(name+" "+x1['Value']+" "+x3['State']['Name']+" "+pubip)
    except:
        pass
