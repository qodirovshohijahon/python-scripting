#!/usr/bin/env python3

import boto3
import json
import os
import os
import pprint


ec2 = boto3.client('ec2')

AWS_REGION = "us-west-1"
EC2_RESOURCE = boto3.resource('ec2', region_name=AWS_REGION)
KEY_PAIR_NAME = "python_keypair"
AMI_ID = 'ami-07ce6c47faac88aa3'


def create_key_pair():
    ec2_client = boto3.client("ec2", region_name=AWS_REGION)
    key_pair = ec2_client.create_key_pair(KeyName="ec2-key-pair")

    private_key = key_pair["KeyMaterial"]

    # write private key to file with 400 permissions
    with os.fdopen(os.open("/home/mustofa/.keys/aws_ec2_key.pem", os.O_WRONLY | os.O_CREAT, 0o400), "w+") as handle:
        handle.write(private_key)

def create_instance():
    ec2_client = boto3.client("ec2", region_name=AWS_REGION)
    instances = ec2_client.run_instances(
        ImageId=AMI_ID,
        MinCount=1,
        MaxCount=1,
        InstanceType='t2.micro',
        KeyName="ec2-key-pair"
    )
    # instance_id = instances[0].instance_id
    print(instances["Instances"][0]["InstanceId"])
    return instances.instance_id

    

def get_public_ip():
    ec2_client = boto3.client("ec2", region_name=AWS_REGION)
    ec2=ec2_client.describe_instances()
    for pythonins in ec2['Reservations']:
        for printout in pythonins['Instances']:
            instance_id = (printout['InstanceId'])
    reservations = ec2_client.describe_instances(InstanceIds=[instance_id]).get("Reservations")

    for reservation in reservations:
        for instance in reservation['Instances']:
            print(instance.get("PublicIpAddress"))



print('****** Now Creating Key Pair *****')
# create_key_pair()
print('****** Now Creating EC2 instances *****')
# create_instance()
print('****** Now Getting IP from instances *****')
get_public_ip()