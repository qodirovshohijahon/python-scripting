import boto3
import json
import os
from json_datetime_serializer import json_datetime_serializer
import logging
from moto import mock_ec2
import botocore

logger = logging.getLogger()
logging.basicConfig(level=logging.INFO,
                    format='%(asctime)s: %(levelname)s: %(message)s')


# Starting the instance using start_instances.
# @mock_ec2
def start_instances(instance_id):
    client = boto3.client('ec2')
    response = client.start_instances(
            InstanceIds=[
                instance_id
            ]
    )
    instance_id = response['StartingInstances'][0]['InstanceId'] 
    instance_start_waiter = client.get_waiter('instance_started')
    try:
        instance_start_waiter.wait(InstanceIds=[instance_id])
        logger.info(f'instance successfully started..with  instance-id: {instance_id}')

    except botocore.exceptions.WaiterError as e:
        if "Max attempts exceeded" in e.message:
            logger.info('Snapshot did not complete in 600 seconds..')
        else:
            logger.info(f'Message---{e.message}')

    return response['StartingInstances'][0]['InstanceId']

    
if __name__ == '__main__':
    logger.info('EC2 Starting function......!')
    instance_id = input('Enter an instance id: ')   
    ec2_start = start_instances(instance_id)
    logger.info('Starting ec2 instance...')
    logger.info(
        f'Starting instance with details: {json.dumps(ec2_start, indent=4, default=json_datetime_serializer)}'
    )
    logger.info('Done!')
    
        