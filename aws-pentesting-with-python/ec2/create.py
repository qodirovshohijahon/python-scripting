#!/usr/bin/env python3

import boto3
import json
import os
import os
import pprint

ec2 = boto3.client('ec2')

AWS_REGION = "us-west-1"
EC2_RESOURCE = boto3.resource('ec2', region_name=AWS_REGION)
KEY_PAIR_NAME = "python_keypair"
AMI_ID = 'ami-07ce6c47faac88aa3'
# KEY_PAIR_NAME = EC2_RESOURCE.create_key_pair(KeyName='ubuntuaws')

# To Get Instance AMIs
"""""
    ec2 = boto3.client('ec2', region_name=AWS_REGION)
    response = ec2.describe_instances()
    for reservation in response["Reservations"]:
        for instance in reservation["Instances"]:
            print(instance["ImageId"])
"""""
keypair_name = "my_python_keypair"

keypair = ec2.create_key_pair(KeyName=keypair_name)

instances = EC2_RESOURCE.create_instances(
    ImageId=AMI_ID,
    MinCount=1,
    MaxCount=1,
    InstanceType='t2.micro',
    KeyName=keypair_name,
)

for instance in instances:
    print(f'EC2 instance "{instance.id}" has been created')
    PEM_FILE=open(keypair,"w")
    PEM_FILE.write(instance['KeyMaterial'])
    PEM_FILE.close
    instance.wait_until_running()
    print(f'EC2 instance "{instance.id}" is running')


# To set security group for EC2 instance and allow SSH access to it from the Internet (
    ec2 = boto3.client('ec2', region_name=AWS_REGION) 
    response = ec2.describe_instances()
    for reservation in response["Reservations"]:
        for instance in reservation["Instances"]:
            print(instance["InstanceId"])
            instance_id = instance["InstanceId"]
            ec2.modify_instance_attribute(
                InstanceId=instance_id, 
                Groups=['sg-0f8f8f8f8f8f8f8f8f']
            )
            
            ec2.authorize_security_group_ingress(
                GroupId='sg-0f8f8f8f8f8f8f8f8f', 
                IpPermissions = [
                    {
                        'IpProtocol': 'tcp',
                        'FromPort': 22, 
                        'ToPort': 22, 
                        'IpRanges': [
                            {
                                'CidrIp': '0.0.0.0/0'
                            }
                        ]
                    }
                ]
            ) 

            print(instance_id)
            print(instance["PublicIpAddress"])
            print(instance["PublicDnsName"])
            print(instance["State"]["Name"])
