#!/usr/bin/env python3

import boto3
import json
import pprint
import boto3
from correct.json_datetime_serializer import json_datetime_serializer
# session = boto3.Session(profile_name='k8s-user')


client = boto3.client('kms',
                      aws_access_key_id='AKIA4RWJ4D2DDZTARPWA', 
                      aws_secret_access_key='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', 
                      region_name='us-west-1')
# write function to update kms policy that add the principal to the policy with the role
def update_kms_policy(client, key_id, principal, role):
    # get the policy
    response = client.get_key_policy(KeyId=key_id, PolicyName='default')
    policy = json.loads(response['Policy'])
    # add the principal to the policy
    policy['Statement'].append({
        'Sid': 'Allow_' + role,
        'Effect': 'Allow',
        'Principal': {
            'AWS': principal
        },
        'Action': 'kms:*',
        'Resource': '*'
    })
    print(json.dumps(policy, indent=4, default=json_datetime_serializer))
    # update the policy
    response = client.put_key_policy(KeyId=key_id, PolicyName='default', Policy=json.dumps(policy))
    print(response)
    return response



update_kms_policy(client, 'f6fb300f-4d7d-48f3-95b2-55816f1c2879', 'arn:aws:iam::862638055046:user/k8s-user', 'EC2-SSH')