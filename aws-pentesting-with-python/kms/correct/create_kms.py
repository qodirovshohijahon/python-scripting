import json
import logging
from datetime import date, datetime
import boto3
from kms_client import kmsClient
from json_datetime_serializer import json_datetime_serializer
from botocore.exceptions import ClientError
import os

# configure logging

logger = logging.getLogger()




def create_kms_key(alias, origin, customerMasterKeySpec, multiRegion, key_usage):
    """
    Creates a unique customer managed KMS key.
    """
    try:
        kms_client = boto3.client(
            "kms",
            aws_access_key_id=os.environ["AWS_ACCESS_KEY_ID"],
            aws_secret_access_key=os.environ["AWS_SECRET_ACCESS_KEY"],
            region_name=os.environ["AWS_REGION"],
        )
        response = kms_client.create_key(
            Description=f"{alias}-{origin}-{multiRegion}-{key_usage}-{customerMasterKeySpec}",
            KeyUsage=key_usage,
            Origin=origin,
            CustomerMasterKeySpec=customerMasterKeySpec,
            MultiRegion=multiRegion,
        )

    except ClientError:
        logger.exception('Could not create a CMK key.')
        raise
    else:
        return response
    
    
if __name__ == '__main__':
    # Constants
    Origin = 'AWS_KMS',
    CustomerMasterKeySpec = 'RSA_2048',
    MultiRegion = True,
    KeyUsage = 'ENCRYPT_DECRYPT',
    
    # KMS_NAME = input('Enter a name for your KMS key: ')
    POLICY = 'default'
    KMS_NAME='alias/demo'
    logger.info('Creating a symetric CMK...')
    kms = create_kms_key(KMS_NAME,
                         Origin,
                         CustomerMasterKeySpec,
                         MultiRegion,
                         KeyUsage,
                         )
    logger.info(
        f'Symetric CMK is created with details: {json.dumps(kms, indent=4, default=json_datetime_serializer)}'
    )
    logger.info('Done!')
    
    