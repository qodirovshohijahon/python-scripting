#!/usr/bin/env python3

import boto3
import json
import sys
import os
import pprint
import boto3

# declare env var for aws-shell


# update kms key policy with target arn and key id Allow use of the key with the role specified in the policy name (default is 'default') 
def update_kms_key_policy(target_arn, key_id):
    kmc_client = boto3.client('kms', region_name='us-west-1')
    kms_key_policy_data = kmc_client.get_key_policy(KeyId=key_id, PolicyName='default')
    kms_key_policy = json.loads(kms_key_policy_data['Policy'])
    policy_update = False
    principial_aws = []
    for statement in kms_key_policy['Statement']:
        if "Allow use of the key" in statement["Sid"]:
            if target_arn not in statement["Principal"]["AWS"]:
                if type(statement["Principal"]["AWS"]) is list:
                    principial_aws.append(statement["Principal"]["AWS"])
                    policy_update = True
                elif type(statement["Principal"]["AWS"]) is str:
                    principial_aws.append(statement["Principal"]["AWS"])
                    policy_update = True
    if policy_update:
        principial_aws.append(target_arn)
        kms_key_policy['Statement'][0]['Principal']['AWS'] = principial_aws
        print(json.dumps(kms_key_policy, indent=4, default=json_datetime_serializer))
        response = kmc_client.put_key_policy(KeyId=key_id, PolicyName='default', Policy=json.dumps(kms_key_policy))
        print(response)
        return response
    